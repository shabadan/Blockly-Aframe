!function(e){function t(n){if(o[n])return o[n].exports;var r=o[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t){function o(e){e&&e.systems.building&&e.systems.building.reexamineBuilding()}function n(e){"position"==e.detail.name&&o(e.detail.target.sceneEl)}function r(){this.lastScene=this.el.sceneEl,o(this.lastScene),this.el.addEventListener("componentchanged",n)}function a(){o(this.lastScene)}function i(){o(this.lastScene),this.lastScene=null,this.el.removeEventListener("componentchanged",n)}AFRAME.registerSystem("building",{reexamineBuilding:function(){function e(e){for(var t=0;t<e.faces.length;t++){var o=e.faces[t],n=o.c;o.c=o.b,o.b=n}}function t(e,t){for(var o=["a","b","c"],n=0;n<e.faces.length;n++){var r=e.faces[n];e.faceVertexUvs[0][n]||(e.faceVertexUvs[0][n]=[]);for(var a=e.faceVertexUvs[0][n],i=0;i<o.length;i++){var s=r[o[i]],l=e.vertices[s];a[i]||(a[i]=new THREE.Vector2);var m=a[i];t(l,m,s)}}e.uvsNeedUpdate=!0}function o(e,o,n,r,a){t(e,function(e,t){t.set(e[o]*r,e[n]*a)})}function n(e){e.computeFaceNormals(),e.computeVertexNormals(),e.computeBoundingBox(),e.computeBoundingSphere()}function r(e){for(var t=[],o=0;o<e.children.length;o++){var n=e.children[o];n.components.wall&&t.push(n)}for(var r=0,a=0;a<t.length;a++){var i=t[a],s=t[(a+1)%t.length],l=i.components.position.data,m=s.components.position.data;r+=(m.x-l.x)*(m.z+l.z)}return r>0&&t.reverse(),t}function a(e){var t=r(e.parentNode),o=t.indexOf(e);return t[(o+1)%t.length]}function i(e,t){var o=e.parentNode,n=a(o);if(n){var r=o.object3D.getWorldPosition(),i=n.object3D.getWorldPosition(),s=t.object3D.getWorldPosition(),l=s.x-r.x,c=s.z-r.z,p=i.x-r.x,d=i.z-r.z,h=Math.atan2(d,p),f=Math.sqrt(p*p+d*d),g=l*Math.cos(-h)-c*Math.sin(-h),v=t.components.doorlink.data.width/2;g=Math.max(g,v+m),g=Math.min(g,f-v-m),e.setAttribute("position",{x:g,y:0,z:0}),e.object3D.updateMatrixWorld()}}function s(e){for(var t=l.el.querySelectorAll("[doorlink]"),o=0;o<t.length;o++){var n=t[o];if(n.components.doorlink.data.from==e)return n;if(n.components.doorlink.data.to==e)return n}}var l=this,m=1e-4;l.dirty||(l.dirty=!0,setTimeout(function(){function a(e){var t=new THREE.Vector3(N,e,0);g.object3D.localToWorld(t),H.myVerts.push(t)}function c(e){var t=e.clone();oe.object3D.worldToLocal(t),ie.vertices.push(t)}l.el.object3D.updateMatrixWorld();for(var p=0;p<l.el.children.length;p++){var d=l.el.children[p];if(d.components&&d.components.room){var h=r(d);if(h.length>2)for(var f=0;f<h.length;f++){var g=h[f],v=h[(f+1)%h.length],u=v.components.position.data.x-g.components.position.data.x,y=v.components.position.data.z-g.components.position.data.z,E=Math.atan2(y,u);g.setAttribute("rotation",{x:0,y:-E/Math.PI*180,z:0}),g.object3D.updateMatrixWorld()}}}for(var M=l.el.querySelectorAll("[doorlink]"),w=0;w<M.length;w++){var x=M[w],A=x.components.doorlink;if(!A)return;i(A.data.from,A.el),i(A.data.to,A.el)}for(var p=0;p<l.el.children.length;p++){var d=l.el.children[p];if(d.components&&d.components.room){var h=r(d);if(h.length>2){for(var f=0;f<h.length;f++){for(var g=h[f],v=h[(f+1)%h.length],u=v.components.position.data.x-g.components.position.data.x,y=v.components.position.data.z-g.components.position.data.z,R=Math.sqrt(u*u+y*y),E=Math.atan2(y,u),b=v.components.position.data.y-g.components.position.data.y,T=v.components.wall.data.height-g.components.wall.data.height,F=[],k=0;k<g.children.length;k++){var j=g.children[k];j.components&&j.components.doorhole&&F.push(j)}F.sort(function(e,t){return e.components.position.data.x-t.components.position.data.x});var z=new THREE.Shape;z.moveTo(0,g.components.wall.data.height),z.lineTo(0,0);for(var C=0;C<F.length;C++){var H=F[C];H.myVerts||(H.myVerts=[]),H.myVerts.length=0;var V=s(F[C]);if(V)for(var S=H.components,D=V.components,P=-1;P<=1;P+=2){var N=S.position.data.x+D.doorlink.data.width/2*P,G=N/R*b,O=G+D.doorlink.data.height,W=g.components.wall.data.height+N/R*T,U=G+W-m;O>U&&(O=U),a(G),a(O),P<0?(z.lineTo(N,G),z.lineTo(N,O)):(z.lineTo(N,O),z.lineTo(N,G))}}z.lineTo(R,v.components.position.data.y-g.components.position.data.y),z.lineTo(R,v.components.position.data.y-g.components.position.data.y+v.components.wall.data.height);var B=new THREE.ShapeGeometry(z);o(B,"x","y",1,1),n(B);var q=g.components.material?g.components.material.material:g.parentNode.components.material.material;g.myMesh?(g.myMesh.geometry=B,g.myMesh.material=q):(g.myMesh=new THREE.Mesh(B,q),g.setObject3D("wallMesh",g.myMesh))}for(var L=[],I=0;I<d.children.length;I++){var J=d.children[I];J.components&&(J.components.floor||J.components.ceiling)&&L.push(J)}for(var K=0;K<L.length;K++){for(var Q=L[K],X=Q.components.ceiling,Y=new THREE.Shape,f=0;f<h.length;f++){var g=h[f],N=g.components.position.data.x,Z=g.components.position.data.z;f?Y.lineTo(N,Z):Y.moveTo(N,Z)}for(var $=new THREE.ShapeGeometry(Y),f=0;f<h.length;f++){var g=h[f],_=$.vertices[f];_.set(_.x,g.components.position.data.y,_.y),X&&(_.y+=g.components.wall.data.height)}X||e($),o($,"x","z",X?1:-1,1),n($),Q.myMeshes||(Q.myMeshes=[]);var ee=X?"ceiling":"floor",q=Q.components.material?Q.components.material.material:Q.parentNode.components.material.material;Q.myMeshes[ee]?(Q.myMeshes[ee].geometry=$,Q.myMeshes[ee].material=q):(Q.myMeshes[ee]=new THREE.Mesh($,q),Q.setObject3D(ee,Q.myMeshes[ee]))}}}}for(var w=0;w<M.length;w++){var x=M[w],A=x.components.doorlink;if(A.data.from&&A.data.to){if(!A.data.from.myVerts)return;if(!A.data.to.myVerts)return;for(var te=0;te<x.children.length;te++){var oe=x.children[te];if(oe.components)for(var ne=["sides","floor","ceiling"],re=0;re<ne.length;re++){var ae=ne[re];if(oe.components[ae]){var q=oe.components.material?oe.components.material.material:oe.parentNode.components.material.material;if(oe.myGeoms||(oe.myGeoms=[]),!oe.myGeoms[ae]){var ie=new THREE.Geometry;oe.myGeoms[ae]=ie;var se=new THREE.Mesh(ie,q);ie.meshRef=se,oe.setObject3D(ae,se),ie.faces.push(new THREE.Face3(0,1,2),new THREE.Face3(1,3,2)),"sides"==ae&&ie.faces.push(new THREE.Face3(4,5,6),new THREE.Face3(5,7,6))}var ie=oe.myGeoms[ae];ie.meshRef.material=q,ie.vertices.length=0;var le=A.data.from.myVerts,me=A.data.to.myVerts;switch(ae){case"floor":c(me[0]),c(me[2]),c(le[2]),c(le[0]),t(ie,function(e,t,o){t.set(1-o%2,1-Math.floor(o/2))});break;case"ceiling":c(me[3]),c(me[1]),c(le[1]),c(le[3]),t(ie,function(e,t,o){t.set(o%2,1-Math.floor(o/2))});break;case"sides":c(me[2]),c(me[3]),c(le[0]),c(le[1]),c(le[2]),c(le[3]),c(me[0]),c(me[1]),t(ie,function(e,t,o){t.set(Math.floor(o/2),o%2),o<4&&(t.x=1-t.x)})}ie.verticesNeedUpdate=!0,ie.elementsNeedUpdate=!0,n(ie)}}}}}l.dirty=!1}))}});var s={init:r,update:a,remove:i};AFRAME.registerComponent("room",Object.assign({schema:{side:{type:"string"}}},s)),AFRAME.registerComponent("wall",Object.assign({schema:{height:{type:"number",default:2.4}}},s)),AFRAME.registerComponent("floor",s),AFRAME.registerComponent("ceiling",s),AFRAME.registerComponent("doorhole",s),AFRAME.registerComponent("doorlink",Object.assign({schema:{from:{type:"selector"},to:{type:"selector"},height:{type:"number",default:2},width:{type:"number",default:.8}}},s)),AFRAME.registerComponent("sides",s),AFRAME.registerPrimitive("rw-room",{defaultComponents:{room:{}},mappings:{side:"room.side"}}),AFRAME.registerPrimitive("rw-wall",{defaultComponents:{wall:{}},mappings:{height:"wall.height"}}),AFRAME.registerPrimitive("rw-floor",{defaultComponents:{floor:{}},mappings:{}}),AFRAME.registerPrimitive("rw-ceiling",{defaultComponents:{ceiling:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorhole",{defaultComponents:{doorhole:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorlink",{defaultComponents:{doorlink:{}},mappings:{from:"doorlink.from",to:"doorlink.to",height:"doorlink.height",width:"doorlink.width"}}),AFRAME.registerPrimitive("rw-sides",{defaultComponents:{sides:{}},mappings:{}})}]);